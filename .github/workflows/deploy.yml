name: Bramj Continuous Deployment

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main 

jobs:
  build-and-deploy:
    # This job runs on your self-hosted runner, likely a PC or Mac, 
    # which needs Docker, SSH/SCP, and the ability to run PowerShell.
    runs-on: self-hosted

    steps:
      # 1️⃣ Checkout repository
      - name: Checkout code
        uses: actions/checkout@v4

      # 2️⃣ Set up QEMU + Docker Buildx
      # These actions ensure Docker can build images for ARM architecture (QEMU emulation).
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 3️⃣ Build Docker image for ARM64
      # This creates an image 'bramj_builder' that contains the necessary cross-compilation tools (like gcc).
      - name: Build Docker image (ARM64)
        run: docker build -t bramj_builder --platform=linux/arm64 .

      # 4️⃣ Compile inside Docker
      # Runs the compilation inside the ARM-compatible Docker image,
      # mounting the workspace so the compiled 'main' binary appears locally.
      - name: Compile inside Docker
        run: |
          docker run --rm -v ${{ github.workspace }}:/work bramj_builder \
            bash -c "
              cd /work
              echo 'Start compiling...'
              gcc -c pigpio/*.c -I/usr/include/pigpio
              ar rcs libpigpio.a *.o
              gcc main.c -L. -lpigpio -lpthread -o main
              echo 'Compilation successful, executable is main'
            "

      # 5️⃣ Ensure SSH directory exists
      # Uses PowerShell to ensure the .ssh folder exists for storing the private key.
      - name: Ensure SSH directory
        shell: powershell
        run: |
          $sshDir = Join-Path $env:USERPROFILE ".ssh"
          if (-Not (Test-Path $sshDir)) { New-Item -ItemType Directory -Path $sshDir | Out-Null }
          Write-Host ".ssh directory ready at $sshDir"

      # 6️⃣ Write SSH private key from secret
      # Writes the private key from the GitHub Secret into a file with secure permissions (Windows icacls).
      - name: Write SSH private key
        shell: powershell
        run: |
          $sshDir = Join-Path $env:USERPROFILE ".ssh"
          $keyPath = Join-Path $sshDir "id_rsa_bramj"
          $env:PI_PRIVATE_KEY | Out-File -FilePath $keyPath -Encoding ascii
          icacls $keyPath /inheritance:r
          icacls $keyPath /grant:r "$($env:USERNAME):(R)"
          Write-Host "Private key written to $keyPath"
        # Corrected Indentation: 'env' must align with 'name', 'shell', and 'run'
        env:
          PI_PRIVATE_KEY: ${{ secrets.PI_PRIVATE_KEY }}

      # 7️⃣ Upload binary to Raspberry Pi
      # Uses SCP to copy the new 'main' executable to the remote Raspberry Pi.
      - name: Upload binary to Raspberry Pi
        shell: powershell
        run: |
          $sshDir = Join-Path $env:USERPROFILE ".ssh"
          $keyPath = Join-Path $sshDir "id_rsa_bramj"
          $piHost = $env:PI_HOST
          $piUser = $env:PI_USER
          $localFile = Join-Path $env:GITHUB_WORKSPACE "main"
          $remoteFile = "/home/$piUser/main"
          $remotePath = "${piUser}@${piHost}:$remoteFile"

          Write-Host "Uploading $localFile to $remotePath ..."
          scp -i $keyPath -o StrictHostKeyChecking=no $localFile $remotePath
          Write-Host "Upload complete."
        # Corrected Indentation: 'env' must align with 'name', 'shell', and 'run'
        env:
          PI_HOST: ${{ secrets.PI_HOST }}
          PI_USER: ${{ secrets.PI_USER }}

      # 8️⃣ Restart program on Raspberry Pi
      # Uses SSH to run remote commands: make the file executable, kill the old tmux session, and start a new one.
      - name: Restart program on Raspberry Pi
        shell: powershell
        run: |
          $sshDir = Join-Path $env:USERPROFILE ".ssh"
          $keyPath = Join-Path $sshDir "id_rsa_bramj"
          $piHost = $env:PI_HOST
          $piUser = $env:PI_USER

          $script = @"
cd /home/$piUser
chmod +x main
tmux kill-session -t bramj || true
tmux new -d -s bramj "./main"
"@

          ssh -i $keyPath -o StrictHostKeyChecking=no $piUser@$piHost $script
        # Corrected Indentation: 'env' must align with 'name', 'shell', and 'run'
        env:
          PI_HOST: ${{ secrets.PI_HOST }}
          PI_USER: ${{ secrets.PI_USER }}
